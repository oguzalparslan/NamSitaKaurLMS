@using NamSitaKaurLMS.WebUI.Areas.Admin.Models.ViewModels
@model List<CoursesViewModel>

<style>
    .table-center th,
    .table-center td {
        text-align: center;
        vertical-align: middle;
    }

        /* Badge veya absolute içeren hücreler merkezleme dışında kalacak */
        .table-center td.position-relative {
            text-align: unset !important;
            vertical-align: middle !important;
        }

            /* Badge’ler hücreyi tam kaplasın */
            .table-center td.position-relative .badge {
                position: absolute;
                top: 0;
                bottom: 0;
                left: 0;
                right: 0;
                display: flex;
                align-items: center;
                justify-content: center;
                width: 100%;
                height: 100%;
                border-radius: 0.375rem; /* köşeleri düzgün */
            }

</style>
<div id="popup"></div>



<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">Aktif Kurslar</h6>
    </div>
    <div class="card-body">
        <div>
            <a id="btnCreateCourse"
               class="btn btn-outline-success">
                Yeni Kurs Tanımla
            </a>
        </div>
        <div class="table-responsive">
            <table class="table table-bordered table-hover align-middle text-center table-center" id="dataTable" width="100%" cellspacing="0">
                <thead>
                    <tr>
                        <th>Adı</th>
                        <th>Kategori</th>
                        <th>Seviye</th>
                        <th>Dil</th>
                        <th>Ücret</th>
                        <th>Süre (dk)</th>

                        <th>Durumu</th>
                        <th>Mekanı</th>
                        <th>Başlangıç Tarihi</th>
                        <th>Bitiş Tarihi</th>

                        <th>Kontenjan</th>
                        <th>Kalan Kontenjan</th>

                        <th>Yayında mı?</th>

                        <th>#Düzenle</th>
                        <th>#Sil</th>
                    </tr>
                </thead>

                <tbody>
                    @foreach (var course in Model)
                    {
                        <tr>
                            <td>@course.Title</td>
                            <td>@course.Category</td>
                            <td>@course.Level</td>
                            <td>@course.Language</td>

                            <td class="p-0 position-relative">
                                @if (course.IsFree || @course.Price == 0)
                                {
                                    <span class="badge bg-success text-light
                                             position-absolute top-0 bottom-0 start-0 end-0
                                             d-flex align-items-center justify-content-center
                                             w-100 h-100">
                                        Ücretsiz
                                    </span>
                                }
                                else
                                {
                                    <span class="d-block px-2 py-1">
                                        @course.Price
                                    </span>
                                }
                            </td>


                            <td>@course.DurationMinutes</td>

                            <td>@course.Status</td>
                            <td>@course.Environment</td>
                            <td>@course.StartDate</td>
                            <td>@course.EndDate</td>

                            <td>@course.Quota</td>
                            <td>0</td>

                            <td class="p-0 position-relative">
                                @if (course.IsPublished)
                                {
                                    <span class="badge bg-info text-light position-absolute top-0 bottom-0 start-0 end-0
                                             d-flex align-items-center justify-content-center w-100 h-100">
                                        Yayında
                                    </span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary text-light position-absolute top-0 bottom-0 start-0 end-0
                                             d-flex align-items-center justify-content-center w-100 h-100">
                                        Taslak
                                    </span>
                                }
                            </td>



                            <td>
                                <a href="#"
                                   class="btn btn-outline-success w-100 btnUpdateCourse"
                                   data-id="@(course.Id ?? 0)">
                                    Düzenle
                                </a>
                            </td>

                            <td>
                                <a class="btn btn-outline-danger w-100 btnDeleteCourse"
                                   asp-area="Admin"
                                   asp-controller="Dashboard"
                                   asp-action="DeleteCourse"
                                   asp-route-id="@course.Id">
                                    Sil
                                </a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>

        </div>
    </div>

</div>

@section Scripts {
    <script>
        //Create popup açma
        document.addEventListener("DOMContentLoaded", function () {
          const popup = document.getElementById("popup");
          const btnCreateCourse = document.getElementById("btnCreateCourse");

          // Yeni Kurs Ekle Popup Açma
          btnCreateCourse.addEventListener("click", async function (e) {
            e.preventDefault();

            const url = '@Url.Action("CreateCourse", "Dashboard", new { area = "Admin" })';

            const res = await fetch(url, { credentials: "same-origin" });
            const html = await res.text();

            popup.innerHTML = html;

            const modalEl = document.getElementById("createCourseModal");
            const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
            modal.show();
          });
        });
        //Create Form Submit
        document.addEventListener("submit", async function (e) {
          const form = e.target;
          if (!form || form.id !== "createCourseForm") return;

          e.preventDefault();

          const popup = document.getElementById("popup");

          const res = await fetch(form.action, {
            method: "POST",
            body: new FormData(form),
            credentials: "same-origin"
          });

          const contentType = (res.headers.get("content-type") || "").toLowerCase();

          // Başarılıysa controller Json dönüyor, validation hatasında HTML partial dönüyor
          if (contentType.includes("application/json")) {
            const data = await res.json();

            if (data.success) {
              window.location.href = data.redirectUrl || window.location.href;
            } else {
              // (Şimdilik) başarısız json senaryosu olursa fallback
              window.location.reload();
            }
          } else {
            const html = await res.text();
            popup.innerHTML = html;

            // partial yeniden basıldığı için modalı tekrar göster
            const modalEl = document.getElementById("createCourseModal");
            const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
            modal.show();
          }
        });
        //Create İptal Butonu
        document.addEventListener("click", function (e) {
          const target = e.target;
          if (!target || target.id !== "btnCancel") return;

          const result = confirm("Yaptığınız değişiklikler iptal edilecek. Onaylıyor musunuz?");
          if (!result) return;

          const form = document.getElementById("createCourseForm");
          if (form) form.reset();

          const modalEl = document.getElementById("createCourseModal");
          if (modalEl) {
            const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
            modal.hide();
          }
        });

        //Update popup açma


        document.addEventListener("click", async function (e) {
          const btn = e.target.closest(".btnUpdateCourse");
          if (!btn) return;

          e.preventDefault();

          const id = btn.dataset.id;
          if (!id) return;

          const popup = document.getElementById("popup");

          // UpdateCourse GET action adresi
          const baseUrl = '@Url.Action("UpdateCourse", "Dashboard", new { area = "Admin" })';
          const url = baseUrl + '?id=' + encodeURIComponent(id);

          const res = await fetch(url, { credentials: "same-origin" });
          const html = await res.text();

          popup.innerHTML = html;


          const modalEl = document.getElementById("updateCourseModal");
          const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
          modal.show();
        });

          document.addEventListener("submit", async function (e) {
          const form = e.target;
          if (!form || form.id !== "updateCourseForm") return;

          e.preventDefault();
          const popup = document.getElementById("popup");

          console.log("form action =>=> " + form.action);

          const res = await fetch(form.action, {
            method: "POST",
            body: new FormData(form),
            credentials: "same-origin",
            headers: { "X-Requested-With": "XMLHttpRequest" } // controller tarafında ayırt etmek istersen
          });

          const contentType = (res.headers.get("content-type") || "").toLowerCase();

          if (contentType.includes("application/json")) {
            const data = await res.json();
            if (data.success) {
              window.location.href = data.redirectUrl || window.location.href;
            } else {
              window.location.reload();
            }
          } else {
            // validation hatasında partial geri döner → modal açık kalsın
            const html = await res.text();
            popup.innerHTML = html;

            const modalEl = document.getElementById("updateCourseModal");
            const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
            modal.show();
          }
        });

    </script>
}
