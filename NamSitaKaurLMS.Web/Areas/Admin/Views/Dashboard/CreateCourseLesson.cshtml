@model NamSitaKaurLMS.WebUI.Areas.Admin.Models.ViewModels.LessonViewModel


<div id="lessonPopup"></div>

<form id="antiForgeryForm" method="post">
    @Html.AntiForgeryToken()
</form>

@* <h2>Kurs : @Model.Select(x => x.CourseTitle).FirstOrDefault()</h2> *@
<h2>Kurs : @Model.Course.Title</h2>

<a id="btnCreateLesson"
   class="btn btn-success mb-3"
   data-course-id="@Model.Course.Id">
    Yeni Ders Tanımla
</a>
<table class="table table-bordered table-striped align-middle lesson-table">
    <thead>
        <tr>
            <td>Sıra</td>
            <td>Ders Adı</td>
            <td>Süre</td>
            <td>Önizleme Mi ?</td>
            <td>İşlemler</td>
        </tr>
    </thead>

    <tbody>
        @foreach (var lesson in Model.lessonDtoList)
        {
            <input type="hidden" name="LessonId" value="@lesson.LessonId" />
            <input type="hidden" name="CourseId" value="@lesson.CourseId" />

            <tr>

                <td>@lesson.Order</td>
                <th>@lesson.Title</th>
                <th>@lesson.DurationMinutes</th>
                <td class="col-preview">
                    <span class="badge bg-@(lesson.IsPreview ? "success" : "secondary") text-light">
                        @(lesson.IsPreview ? "Evet" : "Hayır")
                    </span>
                </td>

                <th>
                    <div class="btn-group">

                        <a class="btn btn-outline-info btn-add-lesson-content"
                           data-lesson-id="@lesson.LessonId"
                           data-course-id="@Model.Course.Id">
                            Ders İçerik Gir
                        </a>

                        <a class="btn btn-outline-warning btn-delete-lesson-content">
                            Ders İçeriği Sil
                        </a>

                        <a class="btn btn-outline-danger btn-delete-lesson"
                           data-lesson-id="@lesson.LessonId"
                           data-course-id="@Model.Course.Id">
                            Dersi Sil
                        </a>
                    </div>


                </th>
            </tr>
        }
    </tbody>
</table>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {
          const popup = document.getElementById("lessonPopup");
          const btn = document.getElementById("btnCreateLesson");
          if (!btn) return;

          btn.addEventListener("click", async function (e) {
            e.preventDefault();

            const courseId = btn.dataset.courseId;
            if (!courseId) return;

            const baseUrl = '@Url.Action("CreateLessonForm", "Dashboard", new { area = "Admin" })';
            const url = `${baseUrl}?courseId=${courseId}`;

            const res = await fetch(url, { credentials: "same-origin" });
            const html = await res.text();

            popup.innerHTML = html;

            const modalEl = document.getElementById("createLessonModal");
            const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
            modal.show();

            modalEl.querySelector("#btnCancel")?.addEventListener("click", () => modal.hide());
          });
        });

          document.addEventListener("submit", async function (e) {
          if (!e.target.matches("#createLessonForm")) return;

          e.preventDefault();
          const form = e.target;

          const res = await fetch(form.action, {
            method: "POST",
            body: new FormData(form),
            headers: { "X-Requested-With": "XMLHttpRequest" },
            credentials: "same-origin"
          });

          const contentType = res.headers.get("content-type") || "";

          // Server validation hatası olursa partial HTML döndürürsün
          if (!contentType.includes("application/json")) {
            const html = await res.text();
            document.getElementById("lessonPopup").innerHTML = html;
            bootstrap.Modal.getOrCreateInstance(document.getElementById("createLessonModal")).show();
            return;
          }

          // Başarılıysa JSON yakala ve yönlendir
          const data = await res.json();
          if (data.success) {
            window.location.href = data.redirectUrl;
          }
        });

                document.addEventListener("click", async function (e) {
          const btn = e.target.closest(".btn-delete-lesson");
          if (!btn) return;

          e.preventDefault();

          const lessonId = btn.dataset.lessonId;
          const courseId = btn.dataset.courseId;

          if (!lessonId) return;

          if (!confirm("Bu dersi silmek istediğine emin misin?")) return;

          // antiforgery token
          const token = document.querySelector('#antiForgeryForm input[name="__RequestVerificationToken"]').value;

          const res = await fetch('@Url.Action("DeleteLesson", "Dashboard", new { area = "Admin" })', {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8",
              "RequestVerificationToken": token,
              "X-Requested-With": "XMLHttpRequest"
            },
            body: new URLSearchParams({ id: lessonId, courseId: courseId }).toString(),
            credentials: "same-origin"
          });

          const data = await res.json();

          if (data.success) {
            // 1) İstersen sadece satırı kaldır:
            btn.closest("tr")?.remove();

            // 2) veya komple refresh:
            // window.location.href = data.redirectUrl;
          }
        });


        document.addEventListener("click", async function (e){
            const btnAddContent = document.querySelectorAll(".btn-add-lesson-content");
            const popup = document.getElementById("lessonPopup");
            if (!btnAddContent) return;

            const btn = e.target.closest(".btn-add-lesson-content");

             if (!btn) return;

            e.preventDefault();


            const form = e.target;
            const courseId = btn.dataset.courseId;
            const lessonId = btn.dataset.lessonId;

            const baseUrl = '@Url.Action("CreateLessonContentForm", "Dashboard", new { area = "Admin" })';
            const url = `${baseUrl}?courseId=${courseId}&lessonId=${lessonId}`;

            const res = await fetch(url, { credentials: "same-origin" });
            const html = await res.text();

            popup.innerHTML = html;

            const modalEl = document.getElementById("createLessonModal");
            const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
            modal.show();        });

    </script>
}
