@{
    ViewData["Title"] = "Ders Tanımlama";
}


@model NamSitaKaurLMS.WebUI.Areas.Admin.Models.ViewModels.LessonViewModel


<div id="lessonPopup"></div>

<form id="antiForgeryForm" method="post">
    @Html.AntiForgeryToken()
</form>

@* <h2>Kurs : @Model.Select(x => x.CourseTitle).FirstOrDefault()</h2> *@
<h2>Kurs : @Model.Course.Title</h2>

<a id="btnCreateLesson"
   class="btn btn-success mb-3"
   data-course-id="@Model.Course.Id">
    Yeni Ders Tanımla
</a>
<table class="table table-bordered table-striped align-middle lesson-table">
    <thead>
        <tr>
            <td>Sıra</td>
            <td>Ders Adı</td>
            <td>Süre (dk)</td>
            <td>Önizleme Mi ?</td>
            <td>Ders İçeriği</td>
            <td>İşlemler</td>
        </tr>
    </thead>

    <tbody>
        @foreach (var lesson in Model.lessonDtoList)
        {
            <input type="hidden" name="LessonId" value="@lesson.LessonId" />
            <input type="hidden" name="CourseId" value="@lesson.CourseId" />

            <tr>

                <td>@lesson.Order</td>
                <td>@lesson.Title</td>
                <td>@lesson.DurationMinutes</td>
                <td class="col-preview">
                    <span class="badge bg-@(lesson.IsPreview ? "success" : "secondary") text-light">
                        @(lesson.IsPreview ? "Evet" : "Hayır")
                    </span>
                </td>
                <td>
                    @*  @if (Model.lessonContentList != null)
                    {
                           @Model.lessonContentList.Where(x => x.LessonId ==  lesson.LessonId).FirstOrDefault().Text
                    } *@

                    @{
                        var content = Model.lessonContentList?
                        .FirstOrDefault(x => x.LessonId == lesson.LessonId);
                    }
                    @(content?.Text ?? "İçerik Bulunamadı !")
                <td>
                    <div class="btn-group">

                        <a class="btn btn-outline-info btn-add-lesson-content"
                           data-lesson-id="@lesson.LessonId"
                           data-course-id="@Model.Course.Id">
                            Ders İçerik Gir
                        </a>

                        <a class="btn btn-outline-warning btn-delete-lesson-content"
                           asp-area="Admin"
                           asp-controller="Dashboard"
                           asp-action="DeleteCourseContentAsync"
                           asp-route-lesson-id="@lesson.LessonId"
                           asp-route-course-id="@lesson.CourseId">
                            Ders İçeriği Sil
                        </a>

                        <a class="btn btn-outline-danger btn-delete-lesson"
                           data-lesson-content-id="@lesson.LessonId"
                           data-course-id="@Model.Course.Id">
                            Dersi Sil
                        </a>
                    </div>


                </td>
            </tr>
        }
    </tbody>
</table>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", () => {
          const popup = document.getElementById("lessonPopup");
          const modalEl = document.getElementById("createLessonModal"); // partial geldiğinde oluşuyor olabilir
          const getModal = () => bootstrap.Modal.getOrCreateInstance(document.getElementById("createLessonModal"));

          async function openPopup(url) {
            const res = await fetch(url, { credentials: "same-origin" });
            const html = await res.text();

            popup.innerHTML = html;

            // popup içeriği geldikten sonra modal zaten DOM’da olacak
            getModal().show();
          }

          function showPopupHtml(html) {
            popup.innerHTML = html;
            getModal().show();
          }

          // ✅ TEK click listener: popup açma / silme / iptal vb.
          document.addEventListener("click", async (e) => {
            // 1) Yeni ders tanımla
            const createLessonBtn = e.target.closest("#btnCreateLesson");
            if (createLessonBtn) {
              e.preventDefault();

              const courseId = createLessonBtn.dataset.courseId;
              if (!courseId) return;

              const baseUrl = '@Url.Action("CreateLessonForm", "Dashboard", new { area = "Admin" })';
              await openPopup(`${baseUrl}?courseId=${courseId}`);
              return;
            }

            // 2) Ders içerik gir
            const addContentBtn = e.target.closest(".btn-add-lesson-content");
            if (addContentBtn) {
              e.preventDefault();

              const courseId = addContentBtn.dataset.courseId;
              const lessonId = addContentBtn.dataset.lessonId;
              if (!courseId || !lessonId) return;

              const baseUrl = '@Url.Action("CreateLessonContentForm", "Dashboard", new { area = "Admin" })';
              await openPopup(`${baseUrl}?courseId=${courseId}&lessonId=${lessonId}`);
              return;
            }

            // 3) Modal iptal
            const cancelBtn = e.target.closest("#btnCancel");
            if (cancelBtn) {
              e.preventDefault();
              getModal().hide();
              return;
            }

            // 4) Ders sil
            const deleteLessonBtn = e.target.closest(".btn-delete-lesson");
            if (deleteLessonBtn) {
              e.preventDefault();

              const lessonId = deleteLessonBtn.dataset.lessonId;
              const courseId = deleteLessonBtn.dataset.courseId;
              if (!lessonId) return;

              if (!confirm("Bu dersi silmek istediğine emin misin?")) return;

              const token = document.querySelector('#antiForgeryForm input[name="__RequestVerificationToken"]')?.value;
              if (!token) return;

              const res = await fetch('@Url.Action("DeleteLesson", "Dashboard", new { area = "Admin" })', {
                method: "POST",
                headers: {
                  "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8",
                  "RequestVerificationToken": token,
                  "X-Requested-With": "XMLHttpRequest"
                },
                body: new URLSearchParams({ id: lessonId, courseId }).toString(),
                credentials: "same-origin"
              });

              const data = await res.json();
              if (data.success) {
                deleteLessonBtn.closest("tr")?.remove();
              }
              return;
            }
          });

          // ✅ TEK submit listener: popup içindeki formlar (create lesson / create content vs.)
          document.addEventListener("submit", async (e) => {
            const form = e.target;
            console.log(e.target);
            // Sadece popup içinden gelen formları yakala
                if (!e.target.matches("#CreateLessonContent")) return;
            // İstersen id bazlı filtrele:
            // if (!["createLessonForm", "createLessonContentForm"].includes(form.id)) return;

            e.preventDefault();

            const res = await fetch(form.action, {
              method: form.method || "POST",
              body: new FormData(form),
              headers: { "X-Requested-With": "XMLHttpRequest" },
              credentials: "same-origin"
            });

            const contentType = res.headers.get("content-type") || "";

            // Validation hatası: partial html geri döner
            if (!contentType.includes("application/json")) {
              const html = await res.text();
              showPopupHtml(html);
              return;
            }

            // Başarılı: JSON
            const data = await res.json();
            if (data.success && data.redirectUrl) {
              window.location.href = data.redirectUrl;
            }
          });
        });
    </script>

}
